name: ğŸ“Š ì§„í–‰ë¥  ì—…ë°ì´íŠ¸

on:
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  update-progress:
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ì§„í–‰ë¥  ê³„ì‚° ë° README ì—…ë°ì´íŠ¸
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            // ìŠ¤í„°ë””ì› ì •ë³´
            const members = {
              'jihostudy': 'ê¹€ì§€í˜¸',
              'hyeonbinHur': 'í—ˆí˜„ë¹ˆ',
              'yeyounging': 'ê³µì˜ˆì˜'
            };

            // ì±•í„° ì •ë³´ (1-16ì¥)
            const chapters = ['1ì¥', '2ì¥', '3ì¥', '4ì¥', '5ì¥', '6ì¥', '7ì¥', '8ì¥', '9ì¥', '10ì¥', '11ì¥', '12ì¥', '13ì¥', '14ì¥', '15ì¥', '16ì¥'];

            // ê° ë©¤ë²„ì˜ ì±•í„°ë³„ ì™„ë£Œ ìƒí™© ì¶”ì 
            const progress = {};
            Object.keys(members).forEach(username => {
              progress[username] = {};
              chapters.forEach(chapter => {
                progress[username][chapter] = false;
              });
            });

            // íŒŒì¼ ì‹œìŠ¤í…œì—ì„œ í•™ìŠµ ë…¸íŠ¸ í™•ì¸
            function checkDirectory(dir) {
              if (!fs.existsSync(dir)) return;
              
              const items = fs.readdirSync(dir, { withFileTypes: true });
              
              for (const item of items) {
                const fullPath = path.join(dir, item.name);
                
                if (item.isDirectory()) {
                  // ì±•í„° í´ë”ì¸ì§€ í™•ì¸ (ì˜ˆ: "1ì¥", "2ì¥")
                  if (chapters.includes(item.name)) {
                    const chapterFiles = fs.readdirSync(fullPath);
                    
                    // ê° ë©¤ë²„ì˜ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
                    Object.keys(members).forEach(username => {
                      const hasFile = chapterFiles.some(file => 
                        file.toLowerCase().includes(username.toLowerCase()) ||
                        file.toLowerCase().includes(members[username])
                      );
                      
                      if (hasFile) {
                        progress[username][item.name] = true;
                      }
                    });
                  }
                  
                  // ì¬ê·€ì ìœ¼ë¡œ í•˜ìœ„ ë””ë ‰í† ë¦¬ í™•ì¸
                  checkDirectory(fullPath);
                }
              }
            }

            checkDirectory('.');

            // ì§„í–‰ë¥  í…Œì´ë¸” ìƒì„± (ë“œë¡­ë‹¤ìš´ìœ¼ë¡œ ê°ì‹¸ê¸°)
            let progressTable = '\n## ğŸ“ˆ ì „ì²´ í•™ìŠµ ì§„í–‰ë¥ \n\n';
            progressTable += '<details>\n';
            progressTable += '<summary>ğŸ“Š ì±•í„°ë³„ ì§„í–‰ í˜„í™© ë³´ê¸°</summary>\n\n';
            progressTable += '| ì±•í„° | ê¹€ì§€í˜¸ | í—ˆí˜„ë¹ˆ | ê³µì˜ˆì˜ |\n';
            progressTable += '| --- | :---: | :---: | :---: |\n';

            chapters.forEach(chapter => {
              progressTable += `| ${chapter} `;
              progressTable += `| ${progress['jihostudy'][chapter] ? 'âœ…' : 'â¬œï¸'} `;
              progressTable += `| ${progress['hyeonbinHur'][chapter] ? 'âœ…' : 'â¬œï¸'} `;
              progressTable += `| ${progress['yeyounging'][chapter] ? 'âœ…' : 'â¬œï¸'} |\n`;
            });

            // ì „ì²´ ì§„í–‰ë¥  ê³„ì‚°
            progressTable += '\n**ì „ì²´ ì§„í–‰ë¥ **\n\n';
            Object.keys(members).forEach(username => {
              const completed = Object.values(progress[username]).filter(v => v).length;
              const total = chapters.length;
              const percentage = Math.round((completed / total) * 100);
              progressTable += `- ${members[username]}: ${completed}/${total} (${percentage}%)\n`;
            });

            progressTable += '\n</details>\n\n---\n';

            // README.md ì½ê¸°
            let readme = fs.readFileSync('README.md', 'utf8');

            // ê¸°ì¡´ ì§„í–‰ë¥  ì„¹ì…˜ ì œê±° (ìˆë‹¤ë©´)
            const progressRegex = /\n## ğŸ“ˆ í•™ìŠµ ì§„í–‰ë¥ \n[\s\S]*?\n---\n/;
            if (progressRegex.test(readme)) {
              readme = readme.replace(progressRegex, '');
            }

            // ìŠ¤í„°ë”” ì¸ì› ì„¹ì…˜ ì•ì— ì§„í–‰ë¥  ì¶”ê°€
            const studyMemberSection = '# ìŠ¤í„°ë”” ì¸ì›';
            if (readme.includes(studyMemberSection)) {
              readme = readme.replace(studyMemberSection, progressTable + studyMemberSection);
            } else {
              // ìŠ¤í„°ë”” ì¸ì› ì„¹ì…˜ì´ ì—†ìœ¼ë©´ ë§¨ ëì— ì¶”ê°€
              readme += '\n' + progressTable;
            }

            // README.md ì—…ë°ì´íŠ¸
            fs.writeFileSync('README.md', readme);

            console.log('âœ… ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ ì™„ë£Œ!');

      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          if git diff --staged --quiet; then
            echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          else
            git commit -m "ğŸ“Š í•™ìŠµ ì§„í–‰ë¥  ìë™ ì—…ë°ì´íŠ¸"
            git push
          fi
<<<<<<< Updated upstream


=======
>>>>>>> Stashed changes
