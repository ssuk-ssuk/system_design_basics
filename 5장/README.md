# 5장: 안정 해시 설계 (Consistent Hashing)

이 챕터는 수평적 규모 확장성을 달성하기 위해 요청이나 데이터를 여러 서버에 균등하게 나누는 핵심 기술인 안정 해시(Consistent Hashing)의 원리와 설계 과정을 다룹니다.

---

## ⚠️ 기존 해시 방식의 문제점

일반적으로 부하 분산을 위해 `hash(key) % N` (N은 서버 개수) 공식을 사용합니다. 하지만 이 방식은 서버가 추가되거나 삭제될 때 심각한 문제를 일으킵니다.

- **서버 변동 시 대규모 재배치:** 서버 대수가 변하면 대부분의 키에 대한 해시 결과값이 달라져, 기존 서버가 아닌 엉뚱한 서버로 접속하게 됩니다.

- **시스템 장애 유발:**
- **캐시 서버:** 대규모 캐시 미스(Cache Stampede)가 발생하여 데이터베이스에 과부하가 걸립니다.

- **샤딩 DB:** 데이터를 재분배(Re-shuffling)하는 과정에서 네트워크 대역폭을 과도하게 사용하며 서비스가 중단될 수 있습니다.

---

## 🎡 안정 해시의 원리

안정 해시는 해시 테이블 크기가 조정될 때 오직 개의 키(k: 키 개수, n: 슬롯 개수)만 재배치하여 효율성을 극대화합니다.

1.  **해시 공간과 해시 링:** 해시 함수 출력 범위를 원형의 해시 링(Hash Ring)으로 구성합니다.

2.  **노드 및 키 배치:** 서버(IP나 이름)와 저장할 데이터의 키를 모두 해시 링 위의 특정 지점에 배치합니다.

3.  **데이터 조회:** 키의 위치에서 **시계 방향**으로 링을 탐색하다가 처음 만나는 서버에 데이터를 저장하거나 조회합니다.

---

## 💎 가상 노드(Virtual Node)를 통한 최적화

단순한 안정 해시는 서버 간 파티션 크기가 불균등해지거나 키가 편중될 수 있는 문제가 있습니다. 이를 해결하기 위해 **가상 노드** 개념을 도입합니다.

- **개념:** 실제 서버 한 대가 해시 링 위에 여러 개의 가상 지점(노드)을 가지도록 설계하는 방식입니다.

- **장점:**
- 재배치되는 키의 수를 최소화합니다.

- 데이터를 더 균등하게 분포시켜 수평적 확장을 용이하게 합니다.

- 특정 서버에 트래픽이 몰리는 **핫스팟 키(Hotspot key)** 문제를 완화합니다.
