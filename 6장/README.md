# 6장: 키-값 저장소 설계 (Key-Value Store Design)

이 챕터는 비관계형 데이터베이스의 한 종류인 **키-값 저장소**를 분산 환경에서 안정적이고 확장 가능하게 설계하는 방법을 다룹니다. 가용성, 일관성, 확장성 사이의 타협점을 찾고 분산 시스템의 복잡한 문제들을 해결하는 메커니즘을 학습합니다.

---

## 🏗️ NoSQL 도입 배경과 특징

전통적인 RDBMS의 수평적 확장 한계와 빅데이터 처리를 위해 등장했습니다.

- **유연한 모델:** 스키마가 없어 데이터 구조 변경이 자유롭습니다.

- **고성능 & 확장성:** 복잡한 JOIN을 배제하여 속도가 빠르며, 서버 추가를 통한 선형적 확장이 가능합니다.

- **고가용성:** 데이터를 여러 노드에 복제하여 장애 시에도 중단 없는 서비스를 제공합니다.

---

## ⚖️ CAP 정리 (Consistency, Availability, Partition Tolerance)

분산 시스템 설계 시 반드시 고려해야 하는 세 가지 요소 중, **두 가지만 선택 가능**하다는 이론입니다.

- **Consistency (일관성):** 어떤 노드에 접속해도 항상 같은 데이터를 보게 됩니다.

- **Availability (가용성):** 일부 노드에 장애가 나도 항상 응답을 받을 수 있습니다.

- **Partition Tolerance (파티션 감내):** 네트워크 장애가 발생해도 시스템이 계속 동작합니다.

- **선택 전략:** 실제 분산 시스템에서는 네트워크 장애를 피할 수 없으므로, **파티션 감내(P)**를 기본으로 두고 **CP(일관성)** 또는 **AP(가용성)** 중 하나를 선택합니다.

---

## 🛠️ 핵심 컴포넌트 및 장애 처리

### 1. 데이터 일관성 유지

- **정족수(Quorum) 프로토콜:** (복제본 수), (쓰기 정족수), (읽기 정족수) 값을 조정하여 시스템의 일관성 수준을 결정합니다.

- **데이터 버저닝 & 벡터 시계:** 충돌을 감지하기 위해 데이터에 `[서버, 버전]` 쌍을 붙여 선후 관계를 판별합니다.

### 2. 장애 감지 및 해소

- **가십 프로토콜 (Gossip Protocol):** 각 노드가 무작위로 선택된 다른 노드들과 박동 카운터(Heartbeat)를 교환하며 분산형 방식으로 장애를 감지합니다.

- **머클 트리 (Merkle Tree):** 사본 간의 일관성이 깨졌을 때, 전체 데이터를 전송하는 대신 차이가 있는 버킷만 찾아 효율적으로 동기화(반-엔트로피 프로토콜)합니다.

### 3. 저장소 최적화 (SSTable & Bloom Filter)

- **SSTable:** 메모리의 데이터를 정렬된 상태로 디스크에 불변(Immutable) 상태로 저장하여 쓰기 성능을 높입니다.

- **블룸 필터 (Bloom Filter):** 특정 키가 SSTable에 있는지 확률적으로 미리 확인하여, 불필요한 디스크 읽기 작업을 획기적으로 줄여줍니다.

---

## 🏁 최종 시스템 아키텍처

- **SPOF 없는 구조:** 모든 노드가 대등한 책임을 지는 완전히 분산된 아키텍처입니다.

- **중재자(Coordinator):** 클라이언트의 요청을 받아 안정 해시 링 위의 적절한 노드로 프락시 역할을 수행합니다.
